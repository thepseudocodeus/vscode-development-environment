---
version: "3"

env:
  PYTHON_VERSION: "3.12.1"
  SRC_DIR: "src"
  TEST_DIR: "tests"
  LOG_DIR: "logs"
  DEPS_FILE: "dependencies.yml"

vars:
  PROJECT_NAME: '{{.PROJECT_NAME | default "my_project"}}'

tasks:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ§­ Meta Tasks
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  help:
    desc: "Show all available tasks"
    cmds:
      - task --list
    summary: |
      Displays all available tasks with descriptions.
      Serves as your development roadmap.

  default:
    desc: "Show help by default"
    cmds:
      - task: help
    summary: Default entrypoint for Taskfile.

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ§© Environment Validation & Setup
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate-system:
    desc: "Ensure core CLI tools exist"
    cmds:
      - which python3 || (echo "âŒ python3 not found" && exit 1)
      - which pip || (echo "âŒ pip not found" && exit 1)
      - which uv || echo "âš ï¸ UV not installed yet"
      - which npm || echo "âš ï¸ npm not installed yet"
    summary: |
      Ensures Python, pip, uv, and npm exist before proceeding.

  install-uv:
    desc: "Install UV (idempotent)"
    deps: [validate-system]
    cmds:
      - |
        if ! command -v uv &> /dev/null; then
          pip install --upgrade pip
          pip install uv
          pip install --upgrade uv
        else
          echo "âš¡ uv already installed."
        fi
    summary: Install or upgrade UV package manager.

  update-pip:
    desc: "Ensure pip is up to date"
    deps: [validate-system]
    cmds:
      - python3 -m pip install --upgrade pip
    summary: Keep pip current for best compatibility.

  uv-init:
    desc: "Initialize UV project if not already present"
    deps: [install-uv, update-pip]
    cmds:
      - |
        if [ ! -f pyproject.toml ]; then
          uv init
          uv venv
        else
          echo "âš¡ UV project already initialized."
        fi
    summary: Idempotent initialization of UV-managed Python project.

  install-python-deps:
    desc: "Install Python dependencies via UV"
    deps: [uv-init]
    cmds:
      - uv pip install -r dev-requirements.txt
    summary: Install all Python packages required for the project.

  install-npm-tools:
    desc: "Install npm-based formatters"
    deps: [validate-system]
    cmds:
      - |
        if command -v npm &> /dev/null; then
          npm install -g prettier
        else
          echo "âš ï¸ npm not found, skipping."
        fi
    summary: Installs global JS/YAML formatters.

  sync-env:
    desc: "Sync Python environment"
    deps: [install-python-deps]
    cmds:
      - uv sync
    summary: Ensure Python environment matches pyproject.lock.

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ§± Project Structure
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-dirs:
    desc: "Create consistent project structure"
    cmds:
      - mkdir -p {{.SRC_DIR}}/core {{.SRC_DIR}}/lib
      - mkdir -p {{.SRC_DIR}}/cli {{.SRC_DIR}}/utils {{.SRC_DIR}}/web
      - mkdir -p {{.TEST_DIR}} docs scripts {{.LOG_DIR}}
    summary: Creates source, test, and documentation directories.

  add-init-files:
    desc: "Idempotently add __init__.py to all subdirectories"
    deps: [build-dirs, sync-env]
    cmds:
      - uv run init_all
    summary: Recursively adds __init__.py files for Python package consistency.

  git-setup:
    desc: "Initialize git repository"
    cmds:
      - |
        if [ ! -d .git ]; then
          git init
          git add .
          git commit -m "Initial commit"
          git branch -M main
        else
          echo "âš¡ Git repository already exists."
        fi
    summary: Setup git repository for version control.

  dev-setup:
    desc: "Complete developer setup"
    deps: [sync-env, build-dirs, add-init-files, git-setup, install-npm-tools]
    cmds:
      - echo "âœ… Development environment ready for {{.PROJECT_NAME}}!"
      - echo "Next steps = start coding, run 'task test', 'task lint', or 'task format'."
    summary: |
      One-shot setup for new environments or fresh containers.
      Fully reproducible, idempotent, and ready for development.

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ”„ Dev Environment Updates
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  update-system:
    desc: "Update system packages"
    cmds:
      - sudo apt update -y
      - sudo apt upgrade -y
    summary: |
      Updates OS-level packages safely. Ensures the base environment is current.

  update-python-deps:
    desc: "Update UV-managed Python packages"
    deps: [uv-init]
    cmds:
      - uv sync
    summary: |
      Updates Python dependencies via UV and synchronizes the environment with pyproject.lock.

  update-npm:
    desc: "Update global npm packages"
    cmds:
      - if command -v npm &> /dev/null; then
        npm update -g prettier @prettier/plugin-yaml yamlfmt;
        else
        echo "âš ï¸ npm not found, skipping";
        fi
    summary: Updates JS/YAML tooling safely if Node is present.

  update-all:
    desc: "Update system, Python, and npm dependencies"
    deps: [update-system, update-python-deps, update-npm]
    cmds:
      - echo "âœ… All updates complete!"
    summary: |
      One command to keep the entire dev environment current.
      Recommended to run regularly for reproducibility and security.

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ§ª Testing & Linting
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    desc: "Run all pytest tests"
    cmds:
      - uv run pytest -v --disable-warnings
    summary: Run tests with UV-managed pytest.

  check-taskfile:
    desc: "Lint the Taskfile.yml itself"
    cmds:
      - echo "ğŸ”¹ Linting Taskfile..."
      - uv run yamllint Taskfile.yml
      - prettier --write Taskfile.yml
      - uv run yamlfmt Taskfile.yml
      - echo "âœ… Taskfile linting complete."

  lint:
    desc: "Run static analysis and linting"
    cmds:
      - uv run black --check {{.SRC_DIR}}
      - uv run flake8 {{.SRC_DIR}}
      - uv run isort --check-only {{.SRC_DIR}}
      - uv run mypy {{.SRC_DIR}}
    summary: Ensure code style and type correctness.

  format:
    desc: "Auto-format code"
    cmds:
      - uv run black {{.SRC_DIR}}
      - uv run isort {{.SRC_DIR}}
      - echo "âœ… Code formatted."
    summary: Automatically format code for style consistency.

  check:
    desc: "Run full QA suite"
    deps: [lint, test, check-taskfile]
    summary: Aggregate linting and testing to validate codebase.

  clean:
    desc: "Clean temporary files"
    cmds:
      - rm -rf __pycache__ .pytest_cache .mypy_cache {{.LOG_DIR}}/*
    summary: Keep project clean and predictable.

  reset-project:
    desc: "Reset project to initial state"
    deps: [clean]
    cmds:
      - rm -rf {{.SRC_DIR}} {{.TEST_DIR}} {{.LOG_DIR}} pyproject.toml pyproject.lock
    summary: |
      Wipe and reinitialize the project structure and environment.
      Useful for starting fresh or recovering from issues.
